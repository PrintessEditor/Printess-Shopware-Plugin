import { PrintessEditor } from "./printessEditor";export class PrintessShopwareIntegration{constructor(t,e){this.name=0,this.product=e,(this.settings=t)&&!t.uiSettings&&(t.uiSettings={showStartupAnimation:"boolean"==typeof t.showStartupAnimation&&t.showStartupAnimation,theme:t.theme||null,uiVersion:"classical",startupBackgroundColor:null,startupLogoUrl:t.startupLogoUrl||null}),this.name=Math.random(),console.log(this.name)}getProductOptionInputSelector(t){return"input[name='"+t+"'], select[name='"+t+"']"}getVariantInputs(){const i=[];return this.recordForeach(this.product.variantOptions,(t,e)=>{document.querySelectorAll(this.getProductOptionInputSelector(t)).forEach(t=>{i.push(t)})}),i}getCurrentProductOptionsFromProductPage(){var t=this.getVariantInputs();const n={},r={};return t.forEach(t=>{var e,i=t.getAttribute("name");this.product.variantOptions.hasOwnProperty(i)&&("SELECT"===t.nodeName?(e=t.value,this.product.variantOptions[i].values.hasOwnProperty(e)&&(n[this.product.variantOptions[i].name]=this.product.variantOptions[i].values[e].name,r[i]=!0)):"radio"===t.getAttribute("type")&&(e=t.value,t.checked)&&this.product.variantOptions[i].values.hasOwnProperty(e)&&(n[this.product.variantOptions[i].name]=this.product.variantOptions[i].values[e].name,r[i]=!0))}),n}getCurrentProductOptions(t){return"cart"!==t.displayMode?this.getCurrentProductOptionsFromProductPage():t.basketItemOptions}recordForeach(t,e){let i=-1;for(const n in t)if(t.hasOwnProperty(n)&&!1===e(n,t[n],++i))break}filterVariantRelatedOptions(t){var e={};for(const r in t)if(t.hasOwnProperty(r)){var i=t[r];for(const s in this.product.variantOptions)if(this.product.variantOptions.hasOwnProperty(s)){var n=this.product.variantOptions[s];if(n.name===r)for(const a in n.values)n.values.hasOwnProperty(a)&&n.values[a].name===i&&(e[r]=i)}}return e}getVariantByProductOptions(t){const e=this.filterVariantRelatedOptions(t);let i=this.product.variants;for(const n in e)e.hasOwnProperty(n)&&(i=i.filter(t=>t.options&&t.options.hasOwnProperty(n)&&t.options[n].optionName===e[n]));return 0<i.length?i[0]:this.product}addOrRemoveTextField(e,i,n,r,s,a=null){if(a=a||this.settings.designNowButtonInstance.closest("form"),Array.isArray(r))r.forEach(t=>{this.addOrRemoveTextField(e,i,n,t,s,a)});else{let t=document.getElementById(r);s?(!t&&a&&((t=document.createElement("input")).setAttribute("id",r),t.setAttribute("name","lineItems["+i+"]["+n+"]"),t.setAttribute("type","hidden"),t.style.display="none",a.appendChild(t)),t&&t.setAttribute("value",s)):t&&t.remove()}}createShopContext(d){const p=this;var t,e,i={templateNameOrSaveToken:"",stickers:[],legalText:this.product.metaData.hasOwnProperty("PrintessLegalText")?this.product.metaData.PrintessLegalText||"":d.priceFormatOptions&&d.priceFormatOptions.legalText?d.priceFormatOptions.legalText:"",legalTextUrl:this.product.metaData.hasOwnProperty("PrintessLegalTextUrl")&&this.product.metaData.PrintessLegalTextUrl||"",snippetPrices:[],chargeEachStickerUsage:!1,hidePricesInEditor:void 0!==p.settings.hidePricesInEditor&&!0===p.settings.hidePricesInEditor,getProductName:()=>p.product.name,formatMoney:t=>{let e=parseFloat(""+t).toFixed(2);var i;return d.priceFormatOptions&&(i={minimumFractionDigits:2,maximumFractionDigits:20},d.priceFormatOptions.rounding&&(i.minimumFractionDigits=d.priceFormatOptions.rounding.decimal,i.maximumFractionDigits=d.priceFormatOptions.rounding.decimal),i={style:"currency",currency:d.priceFormatOptions.currencyIsoCode,...i},e=t.toLocaleString(function(){var t,e,i;if("object"==typeof navigator)return t="anguage",(i=(e=navigator).languages)&&i.length?i:(t=e["l"+t]||e["browserL"+t]||e["userL"+t])&&[t]}()[0]??"en-US",i)),e},getMergeTemplates:()=>{var e=[];if(this.product.metaData.hasOwnProperty("PrintessMergeTemplates")&&this.product.metaData.PrintessMergeTemplates)try{var t=JSON.parse(this.product.metaData.PrintessMergeTemplates);t&&e.push("string"==typeof t?{templateName:t||""}:t)}catch(t){e.push({templateName:this.product.metaData.hasOwnProperty("PrintessMergeTemplates")&&this.product.metaData.PrintessMergeTemplates||""})}return e},onFormFieldChanged:(a,o,p,u)=>{let e=this.getVariantByProductOptions(this.getCurrentProductOptions(d));if(d.basketItemOptions||(d.basketItemOptions={}),d.basketItemOptions[a]=o,"cart"!==d.displayMode){let r=null,s=null;this.recordForeach(this.product.variantOptions,(t,e)=>{if(e.name===a||e.name===p)for(const n in e.values)if(e.values.hasOwnProperty(n)){var i=e.values[n];if(o===i.name||i.name===u)return r=n,s=e.id,!1}}),null!=r&&null!=s&&document.querySelectorAll(this.getProductOptionInputSelector(s)).forEach(e=>{var t=e.getAttribute("name");if(this.product.variantOptions.hasOwnProperty(t))if("SELECT"===e.nodeName){e.value=r;for(let t=0;t<e.options.length;++t)e.options[t].selected=e.options[t].value===r}else"radio"===e.getAttribute("type")&&(e.checked=e.value===r)});var t=document.querySelectorAll("[name^='lineItems\\["+e.id+"]'");const i="lineItems["+e.id+"]";e=this.getVariantByProductOptions(this.getCurrentProductOptions(d)),t.forEach(t=>{t.getAttribute("name")===i+"[id]"&&(t.value=e.id),t.setAttribute("name",t.getAttribute("name").replace(i,"lineItems["+e.id+"]"))})}},onAddToBasket:(e,i)=>{if("cart"===d.displayMode){var t,n,r=document.getElementById("printessupdateLineItem"+d.lineItemId);r&&(s=r.querySelector("input[name='lineItems\\[id\\]'],input[name='lineItems\\[0\\]\\[id\\]']"),a=r.querySelector("input[name='lineItems\\[quantity\\]'],input[name='lineItems\\[0\\]\\[quantity\\]']"),t=r.querySelector("input[name='lineItems\\[referencedId\\]'],input[name='lineItems\\[0\\]\\[referencedId\\]']"),n=r.querySelector("input[name='lineItems\\[payload\\]'],input[name='lineItems\\[0\\]\\[payload\\]']"),s&&(s.value=d.lineItemId),a&&(a.value=d.lineItem.quantity.toString()),t&&(t.value=d.lineItem.referencedId),n&&(n.value=JSON.stringify({_printessProductOptions:d.basketItemOptions,_printessSaveToken:e,_printessThumbnailUrl:i})),r.submit())}else{const o=this.getVariantByProductOptions(p.getCurrentProductOptions(d));var s=this.settings.designNowButtonInstance.closest("form"),a=(console.log(o),this.addOrRemoveTextField(d,o.id,"_printessSaveToken","printess_save_token_input_"+o.id,e,s),this.addOrRemoveTextField(d,o.id,"_printessThumbnailUrl","printess_thumbnail_url_input_"+o.id,i,s),this.addOrRemoveTextField(d,o.id,"_printessProductOptions","printess_product_options_"+o.id,JSON.stringify({...d.basketItemOptions||{},...this.getCurrentProductOptionsFromProductPage()}),s),document.getElementsByName("lineItems["+o.id+"][stackable]"));a&&a.forEach(t=>t.value="0");let t=document.getElementsByName("lineItems["+o.id+"][id]");t&&t.forEach(t=>t.value=""+o.id),(t=document.getElementsByName("lineItems["+o.id+"][referencedId]"))&&t.forEach(t=>t.value=""+o.id),this.settings.addToBasketButtonInstance&&this.settings.addToBasketButtonInstance.click()}},getCurrentFormFieldValues:()=>p.getCurrentProductOptions(d),getPriceForFormFields:t=>{var e=p.getVariantByProductOptions(p.getCurrentProductOptions(d)),i=e.price[0].gross;return d.priceFormatOptions&&!d.priceFormatOptions.grossPrice&&e.price[0].net,i},getFormFieldMappings:()=>{let t={};if(this.product.metaData.hasOwnProperty("PrintessFormFieldMappings")&&this.product.metaData.PrintessFormFieldMappings)try{t=JSON.parse(this.product.metaData.PrintessFormFieldMappings)}catch(t){console.error(t)}return t},getPriceInfo:()=>null,editorClosed:t=>{}};return d.saveToken?i.templateNameOrSaveToken=d.saveToken:(t=this.getCurrentProductOptions(d),e=this.getVariantByProductOptions(t),i.templateNameOrSaveToken=this.doDisplayDesignNowButton(t)?e.metaData.PrintessTemplateName||this.product.metaData.PrintessTemplateName:this.product.metaData.PrintessTemplateName||""),i}doDisplayDesignNowButton(t){let e=!1;this.product.variants.forEach(t=>{e=e||t.metaData.hasOwnProperty("PrintessTemplateName")&&t.metaData.PrintessTemplateName&&!0});t=this.getVariantByProductOptions(t);return e?t.metaData.hasOwnProperty("PrintessTemplateName")&&t.metaData.PrintessTemplateName&&!0:this.product.metaData.hasOwnProperty("PrintessTemplateName")&&this.product.metaData.PrintessTemplateName&&!0}showDesignNowButton(t){this.settings.designNowButtonInstance&&this.settings.addToBasketButtonInstance&&(this.settings.addToBasketButtonInstance.getAttribute("data-orig-display")||this.settings.addToBasketButtonInstance.setAttribute("data-orig-display",this.settings.addToBasketButtonInstance.style.display),this.settings.addToBasketButtonInstance.style.display=t?"none":this.settings.addToBasketButtonInstance.getAttribute("data-orig-display"),this.settings.designNowButtonInstance.style.display=t?"inline-block":"none")}initProductPage(){this.showDesignNowButton(this.doDisplayDesignNowButton(this.getCurrentProductOptionsFromProductPage()))}show(t){"cart"!==t.displayMode&&(e=this.settings.designNowButtonInstance.closest("form"))&&(e=e.querySelector("input[name^='lineItems\\['][name$='\\]\\[id\\]']"))&&(e=e.getAttribute("name").replace("lineItems[","").replace("][id]",""),t.lineItemId=e);var e=this.createShopContext(t);new PrintessEditor(this.settings).show(e)}};